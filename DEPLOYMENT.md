# Deployment Guide

Questo progetto supporta deployment su **Vercel** (raccomandato) o **GitHub Pages**.

**Entrambi i deploy usano il base path `/biliardino-elo/`** per consistenza.

## üöÄ Vercel (Raccomandato)

Vercel ospita sia il frontend che le API serverless su un unico dominio.

### Setup

1. **Collega il repository a Vercel**
   - Vai su [vercel.com](https://vercel.com)
   - Import il repository GitHub
   - Framework Preset: Vite

2. **Configura le Environment Variables**

   Nel Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables, aggiungi:

   ```bash
   # API Authentication
   AUTH_JWT_SECRET=<your-secret-key>
   
   # Push Notifications
   VITE_VAPID_PUBLIC_KEY=<your-public-key>
   VAPID_PRIVATE_KEY=<your-private-key>
   
   # Vercel Blob Storage
   BLOB_READ_WRITE_TOKEN=<auto-generated>
   
   # Vercel KV (Redis)
   KV_REST_API_URL=<auto-generated>
   KV_REST_API_TOKEN=<auto-generated>
   KV_REST_API_READ_ONLY_TOKEN=<auto-generated>
   
   # CORS
   ACCESS_CONTROL_ALLOW_ORIGIN=<your-frontend-url>
   ```

   Per generare una secret robusta:
   ```bash
   openssl rand -base64 64 | tr -d '\n'
   ```

   > **Note**: `BLOB_READ_WRITE_TOKEN` e le variabili `KV_*` vengono generate automaticamente quando aggiungi Vercel Blob e KV al progetto.

3. **Aggiungi Vercel Integrations**
   - **Vercel Blob**: Per salvare le push subscriptions
   - **Vercel KV**: Per le conferme temporanee con auto-expire

4. **Deploy**
   ```bash
   npx vercel --prod
   ```
   
   O fai push su `main` per auto-deploy.

### URL Risultante
- **Frontend**: `https://your-project.vercel.app/biliardino-elo/`
- **API Endpoints**: `https://your-project.vercel.app/api/*`

> Le rewrites in `vercel.json` gestiscono automaticamente il routing da `/biliardino-elo/*` ai file corretti.

---

## üì¶ GitHub Pages (Alternative)

GitHub Pages ospita solo il frontend. Le API devono essere deployate separatamente su Vercel.

### Setup

1. **Configura GitHub Secrets**
   
   Vai su Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions
   
   Aggiungi:
   ```bash
   API_BASE_URL=https://your-api.vercel.app/api
   VAPID_PUBLIC_KEY=<your-public-key>
   ```

2. **Deploy API su Vercel**
   
   Crea un progetto Vercel separato per le sole API, o usa lo stesso progetto.

3. **Deploy Frontend su GitHub Pages**
   
   Il workflow `.github/workflows/deploy.yml` si attiva automaticamente su push a `main`.

### URL Risultanti
- **Frontend**: `https://username.github.io/biliardino-elo/`
- **API**: `https://your-api.vercel.app/api/*`

---

## üß™ Development

```bash
npm run dev
```

- Il dev server usa `http://localhost:5173/biliardino-elo/`
- Il proxy Vite in `vite.config.ts` gestisce le chiamate API in sviluppo

---

## üîÑ CORS

Le API hanno CORS abilitato per default in `api/_cors.js`:
- `Access-Control-Allow-Origin` √® configurato tramite variabile d'ambiente
- Imposta `ACCESS_CONTROL_ALLOW_ORIGIN` con il tuo dominio frontend (es: `https://your-domain.com`)

---

## üîê API Authentication

La maggior parte degli endpoint API √® protetta con JWT (JSON Web Tokens) usando HS256.

### Ruoli Disponibili

- **`admin`**: Accesso completo, per operazioni di gestione
- **`cron`**: Per job automatici schedulati
- **`notify`**: Per inviare notifiche push

### Endpoint Protetti

Le seguenti API richiedono l'header `Authorization: Bearer <token>`:

| Endpoint | Ruolo Richiesto | Descrizione |
|----------|----------------|-------------|
| `/api/cron-handler` | `cron` | Orchestratore job schedulati |
| `/api/run-matchmaking` | `admin` | Matchmaking automatico |
| `/api/send-broadcast` | `notify` | Notifiche broadcast |
| `/api/send-notification` | `notify` | Notifiche a singolo player |
| `/api/declarative-push` | `notify` | Push notifiche declarative |
| `/api/test-notification` | `admin` | Test notifiche |
| `/api/confirm-availability` | `admin` | Conferma disponibilit√† |

### Endpoint Pubblici

- `/api/subscription` - Registrazione subscription push (no auth richiesta)
- `/api/get-confirmations` - Lettura conferme (endpoint pubblico, al momento **senza** auth)

### Generare un Token

Usa lo script fornito per generare token firmati:

> Il comando carica automaticamente le variabili da `.env.local` (se presente) o `.env` nella root del progetto.

```bash
# Genera token per cron (scadenza 1 anno)
AUTH_JWT_SECRET=your-secret node scripts/generate-token.js cron

# Genera token per admin (scadenza 1 giorno)
AUTH_JWT_SECRET=your-secret node scripts/generate-token.js admin 86400

# Genera token per notify
AUTH_JWT_SECRET=your-secret node scripts/generate-token.js notify
```

Il token generato va usato nell'header:
```bash
Authorization: Bearer <token>
```

### Setup per GitHub Actions

Per i cron job schedulati, aggiungi il token come secret:

1. Genera un token con ruolo `cron`:
   ```bash
   AUTH_JWT_SECRET=your-secret node scripts/generate-token.js cron
   ```

2. Vai su Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions

3. Aggiungi il secret:
   - Nome: `API_TOKEN`
   - Valore: il token generato

Il workflow `.github/workflows/cron.yml` user√† automaticamente questo token.

### Sicurezza

- ‚ö†Ô∏è **Non committare mai** `AUTH_JWT_SECRET` nel repository
- üîí Usa una chiave complessa e casuale (es: 64+ caratteri)
- üîÑ Ruota periodicamente i token in caso di leak
- üìã La scadenza del token √® opzionale; se omessa il token non ha exp (sconsigliato in produzione)
- ‚ùå Token invalidi/scaduti/mancanti ricevono `401 Unauthorized`
- üö´ Token con ruolo insufficiente ricevono `403 Forbidden`

---

## üìä Cron Jobs

### Vercel (Raccomandato)

Configurati in `vercel.json`:
- `58 10,15 * * *`: Invia notifiche broadcast per i match delle 11:00 e 16:00

### GitHub Actions (Alternativa)

Se usi GitHub Pages, puoi usare GitHub Actions scheduled workflows in `.github/workflows/cron.yml`:

```yaml
on:
  schedule:
    - cron: '58 10 * * *'  # 10:58 UTC
    - cron: '58 15 * * *'  # 15:58 UTC
```

**‚ö†Ô∏è Limitazioni di GitHub Actions:**
- Usa UTC (non timezone locale)
- Pu√≤ avere ritardi fino a 15 minuti
- Si disattiva dopo 60 giorni di inattivit√† del repository
- Massimo 1 esecuzione ogni 5 minuti

**Setup:**
1. Aggiungi il secret `VERCEL_API_URL` (es: `https://your-api.vercel.app`)
2. Il workflow chiamer√† `/api/cron-handler` al momento programmato
3. Attiva manualmente da Actions ‚Üí Scheduled Notifications ‚Üí Run workflow per testing
